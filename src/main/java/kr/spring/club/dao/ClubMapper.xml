<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper  namespace="kr.spring.club.dao.ClubMapper">
	<insert id="insertClub" parameterType="clubVO" useGeneratedKeys="true" keyProperty="club_num">
		insert into club
			(id,club_loc,club_name,club_detail,club_img,club_color,filename,club_age,club_locX,club_locY,club_address)
		values
			(#{id},#{club_loc},#{club_name},
		<if test="club_detail !=''">
			#{club_detail},
		</if>
		<if test="club_detail ==''">
			'',
		</if>
		<if test="club_img !=''">
			#{club_img},
		</if>
		<if test="club_img ==''">
			'',
		</if>
		<if test="club_color !=''">
			#{club_color},
		</if>
		<if test="club_color ==''">
			'',
		</if>
		<if test="filename !=''">
			#{filename},
		</if>
		<if test="filename ==''">
			'',
		</if>
		#{club_age},#{club_locX},#{club_locY},#{club_address})
		 <selectKey keyProperty="club_num" resultType="integer" order="AFTER">
		 	select max(club_num) as club_num from club
		 </selectKey>
	</insert>
	<update id="updateClub" parameterType="clubVO">
		update club set id=#{id}, club_loc=#{club_loc}, club_name=#{club_name},
		<if test="club_detail !=''">
			club_detail=#{club_detail},
		</if>
		<if test="club_img != null">
			club_img=#{club_img},
		</if>
		<if test="club_color !=''">
			club_color=#{club_color},
		</if>
		<if test="filename !=null">
			filename=#{filename},
		</if>
		club_age=#{club_age},club_locX=#{club_locX},club_locY=#{club_locY},club_address=#{club_address} where club_num=#{club_num}
	</update>
	<select id="selectAwayDetailsForRequestedMatch" parameterType="integer" resultType="clubVO">
	select * from (select e.manner,e.perform,d.club_num,d.request_num,d.match_num,d.acceptance,d.address,d.type,d.start_time,d.end_time,d.match_date,d.request_detail,d.match_detail from
    	(select a.request_num,a.match_num,a.club_num,a.acceptance,a.request_detail,b.type,b.home,b.start_time,b.end_time,b.address,b.match_detail,b.cost,b.match_date from
    		(select request_num,match_num,away club_num,acceptance,request_detail from match_request ) a
    		join match b on a.match_num=b.match_num where b.match_date>sysdate-1 and b.home=#{club_num})d
    left outer join 
    	(select avg(manner) manner,avg(perform) perform,club_num from club_rating group by club_num)e
    		 on d.club_num=e.club_num) f join club c on f.club_num=c.club_num
	</select>
	<select id="selectHomeDetailsForRequestedMatch" parameterType="integer" resultType="clubVO">
	select * from (select * from
    	(select * from
    		(select match_num,away club_num,acceptance,request_detail from match_request where away=#{club_num} ) a 
    		join match b on a.match_num=b.match_num where b.match_date>sysdate-1)d
    left outer join 
    	(select avg(manner) manner,avg(perform) perform,count(*) rating_count,club_num from club_rating group by club_num)e 
    	on d.home=e.club_num) f join club c on f.home=c.club_num
	</select>
	<select id="selectAttendanceRate" parameterType="memberVO" resultType="float">
	select b.b/a.a attendance_rate from
    (select count(match_num) a, 37 club_num from match where (home=37 or away=37) and match_date>(select join_date from club_join where id=#{id} and club_num=37) )a 
    join
    (select count(match_num) b,club_num from match_vote where id=#{id} and status=1 group by club_num having club_num=37) b on a.club_num=b.club_num
	</select>
	<select id="selectMyClubDetails" parameterType="clubVO" resultType="clubVO">
	select * from
    (select a.club_num,club_loc,club_age,club_name,club_detail,club_img,club_color,club_locX,club_locY,club_address,filename,manner,perform,rating_count from
            (select * from club where club_num=#{club_num}) a left outer join
        (select avg(manner) manner,avg(perform) perform, COUNT(*) rating_count,club_num from club_rating group by club_num) b on a.club_num=b.club_num)c join club_join d on c.club_num=d.club_num where d.id=#{id}
	</select>
</mapper>
