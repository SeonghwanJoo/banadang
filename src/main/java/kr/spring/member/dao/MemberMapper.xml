<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper  namespace="kr.spring.member.dao.MemberMapper">
	<insert id="insertMember_detail" parameterType="memberVO">
	insert into member_detail
		(id,nickname,profile_image,thumbnail_image,email,age_range) 
	values
		(#{id},#{nickname},#{profile_image},#{thumbnail_image},#{email}
		<if test="age_range != null">
			,#{age_range}
		</if>
		)
	</insert>
	<update id="updateMember_detail" parameterType="memberVO">
	update member_detail set 
		nickname=#{nickname},profile_image=#{profile_image},thumbnail_image=#{thumbnail_image},email=#{email}
		<if test="age_range != null">
		,age_range=#{age_range}
		</if>
		 where id=#{id}	
	</update>   
	<select id="selectMyRecruitReq" parameterType="string" resultType="matchVO">
		select * from 
    (select recruit_req_num,isCanceled,c.id,c.match_num,c.club_num,recruit_position,recruit_accept,type,start_time,end_time,cancel,address,match_date,address_x,address_y,club_name,club_img,club_color,club_age from
        (select recruit_req_num,isCanceled,a.match_num,a.id,club_num,recruit_accept,recruit_position,type,start_time,end_time,cancel,address,match_date,address_x,address_y from
            (select * from recruit_req where id=1459494566) a join (select * from match where match_date>sysdate-1) b on a.match_num=b.match_num)c join club d on c.club_num=d.club_num) e left outer join
    (select avg(manner) manner,avg(perform) perform,club_num,count(*) count from club_rating group by club_num) f on e.club_num=f.club_num
	</select>
	<insert id="insertClubRecruit" parameterType="matchVO" useGeneratedKeys="true" keyProperty="clubRecruit_num">
	insert into club_recruit (id,club_num,act_day,act_time,register_cost,month_cost,type,recruit_position,recruit_due,clubRecruit_detail)
		values
		(#{id},#{club_num},#{act_day},#{act_time},#{register_cost},#{month_cost},#{type},#{recruit_position},#{recruit_due},
		<if test="clubRecruit_detail==''">
			''
		</if>
		<if test="clubRecruit_detail!=''">
			#{clubRecruit_detail}
		</if>
		)
		<selectKey keyProperty="clubRecruit_num" resultType="integer" order="AFTER">
			select max(clubRecruit_num) as clubRecruit_num from club_recruit
		</selectKey>
	</insert>
	<select id="selectClubRecruitWithClubDetail" parameterType="integer" resultType="matchVO">
		  select * from 
    (select club_num,clubRecruit_num,act_day,act_time,register_cost,month_cost,type,recruit_position,clubRecruit_detail,a.id,club_name,club_img,club_color,club_age,club_address,club_loc,club_locX,club_locY from
        (select * from club_recruit where clubRecruit_num=1)a join club b using(club_num)) left outer join 
    (select avg(manner),avg(perform),count(*) count,club_num from club_rating group by club_num) using(club_num)
	</select>
	<select id="selectClubRecruits" resultType="matchVO">
		select * from (select * from (select * from club_recruit where recruit_due>sysdate-1) join club using(club_num)) left outer join 
    (select avg(manner),avg(perform),count(*) count,club_num from club_rating group by club_num) using(club_num)
	</select>
	<update id="updateClubRecruit" parameterType="matchVO">
		update club_recruit set act_day=#{act_day},act_time=#{act_time},register_cost=#{register_cost},month_cost=#{month_cost},type=#{type},recruit_position=#{recruit_position},clubRecruit_detail=#{clubRecruit_detail},recruit_due=#{recruit_due} where clubRecruit_num=#{clubRecruit_num}
	</update>
	<insert id="insertClubRecruitReq" parameterType="matchVO">
		insert into clubRecruit_req (id,club_num,clubRecruit_req_detail,recruit_position,clubRecruit_accept,clubRecruit_num)
		values (#{id},#{club_num},#{clubRecruit_req_detail},#{recruit_position},1,#{clubRecruit_num})
	</insert>
	<select id="selectMyClubRecruitReq" parameterType="string" resultType="matchVO">
	select * from (select * from
    (select clubRecruit_num,clubRecruit_req_num,id,clubRecruit_req_detail,a.recruit_position,recruit_due,clubRecruit_accept,act_day,act_time,type,a.club_num from
        (select * from clubRecruit_req where id=#{user_id}) a
            join club_recruit b using(clubRecruit_num) where recruit_due>sysdate-1)a join club b using(club_num))c left outer join
            (select avg(manner) manner,avg(perform)perform,club_num from club_rating group by club_num) using(club_num)
	</select>
	<select id="selectMatchForMsg" parameterType="msgVO" resultType="msgVO">
		<if test="match_num != null">
			select * from
   				 (select nickname,thumbnail_image,a.id,club_num,club_name,club_img,#{match_num} as match_num from
       				 (select nickname,thumbnail_image,id,#{club_num} as club_num from member_detail where id=#{id})a left outer join club using(club_num))b left outer join match using(match_num)
		</if>
		<if test="match_num == null">
    		select nickname,thumbnail_image,a.id,club_num,club_name,club_img from
       			(select nickname,thumbnail_image,id,#{club_num} as club_num from member_detail where id=#{id})a left outer join club using(club_num)
		</if>
	</select>
	<insert id="insertMsg" parameterType="msgVO">
		insert into msg (sender,receiver,content,match_num,club_num) 
		values (#{sender},#{receiver},#{content},
		<if test="match_num == null">
		'',
		</if>
		<if test="match_num != null">
		#{match_num},
		</if>
		<if test="club_num == null">
		''
		</if>
		<if test="club_num != null">
		#{club_num}
		</if>
		)
	</insert>
</mapper>
